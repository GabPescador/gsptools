---
title: "`r paste0(params$report_title, ' TMT diGly Report')`"
author: da Silva Pescador, G
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    self_contained: true
params:
  results: NA
  report_title: NA
  excel_files: NA
editor_options: 
  chunk_output_type: console
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE
)
```

# Introduction

This report was created to facilitate visualization of proteomics experiments performed at the Kostova Lab.

Specifically, this report will go over standard quality control plots (PCA, correlation, boxplots) and result plots for diGly TMT experiments.

This will function as an intermediate step while I slowly build a ShinnyApp for users to explore the data interactively.

# Result files

This report uses as a base the PROT-XXXX_results.xlsx file, where all data is compiled after analysis and can be downloaded below. XXXX will be the LIMS number related to your proteomics project submitted.

Descriptions of each sheet included in the document can be found in the first page "Description" of the excel file.

```{r}
downloadthis::download_file(
                path = params$excel_files,
                button_label = "Download All Excel File (ZIP)",
                button_type = "default",
                has_icon = TRUE,
                icon = "fa fa-file-archive",
                self_contained = TRUE
                )
```

# Quality Control {.tabset .tabset-fade}

## Normalized Abundances {.tabset .tabset-fade}

This step is performed by the NormalyzerDE package (specialized for TMT data), and normalizes abundances between replicates. More details on how the function performs the normalization can be found in [NormalyzerDE](http://doi.org/10.1021/acs.jproteome.8b00523).

Ideally, all boxplots have a similar distribution between replicates.

### Input total proteome
```{r, fig.height=4, fig.width=8}
print(params$results[["Quality Control"]]$plots[["InputNormalization"]])
```

### diGly
```{r, fig.height=4, fig.width=8}
print(params$results[["Quality Control"]]$plots[["diGlyNormalization"]])
```

## Correlation Plots

Ideally, all replicates from the same group should cluster together and have > 0.9 correlation coefficient. For proteomics data it is not unusual to consider > 0.8 as good correlation between replicates.

### Input total proteome
```{r, fig.height=4, fig.width=4}
print(params$results[["Quality Control"]]$plots[["InputCor"]])
```

### diGly
```{r, fig.height=4, fig.width=4}
print(params$results[["Quality Control"]]$plots[["diGlyCor"]])
```

## PCA Plots

Ideally, groups should cluster together. If there is technical variance you might see replicates clustering together instead, which represents a problem for downstream analyses.

If that's the case, one might decide to get rid of a weird replicate. Alternatively, one might want to correct the bacth effect by applying something like [proBatch](https://www.embopress.org/doi/full/10.15252/msb.202110240).

```{r, fig.width=ifelse(length(params$results[["Quality Control"]]$plots[["PCA"]]) > 2, 8, 8), fig.height=ifelse(length(params$results[["Quality Control"]]$plots[["PCA"]]) > 2, 8, 4)}
print(params$results[["Quality Control"]]$plots[["PCA"]])
```

# Data Visualization {.tabset .tabset-fade}

All comparative plots are based on the specified contrasts below, where groups are separated by "-", and comparisons are always interpreted as Group1/Group2. Positive foldchanges are related to proteins/sites that are upregulated in Group1 in comparison to Group2.

In addition, all plots are highlighted for ribosome proteins and biogenesis factors, based on [this paper](https://doi.org/10.15252/embj.2022112699). The list with details on each protein function can be downloaded below.

```{r}
knitr::kable(params$results[["Quality Control"]]$tables[["Contrasts"]])

DT::datatable(gsptools::biogenesisProteinOrder,
    extensions = 'Buttons',
    caption = "Biogenesis Factors",
    options = list(
      dom = 'Bfrtip',
      buttons = c('csv', 'excel')
    )
  )
```

## Unique modified sites/proteins {.tabset .tabset-fade}

All comparative plots exclude unique modified sites/proteins since they cannot perform statistics on things that are present in one sample but not in another. These are still interesting candidates and are summarized in the list below.

Be mindful that the pipeline defines sites/proteins that are not found in at least 2 replicates as not expressed in the samples. Therefore, unique sites/proteins might come from things that were present in just one replicate rather than completely not present in a certain sample.

### Input total proteome
```{r}
DT::datatable(params$results[["Quality Control"]]$tables[["InputUnique"]],
    extensions = 'Buttons',
    caption = "Input Unique Proteins",
    options = list(
      dom = 'Bfrtip',
      buttons = c('csv', 'excel')
    )
  )
```

### diGly
```{r}
DT::datatable(params$results[["Quality Control"]]$tables[["diGlyUnique"]],
    extensions = 'Buttons',
    caption = "diGly Unique Modified Sites",
    options = list(
      dom = 'Bfrtip',
      buttons = c('csv', 'excel')
    )
  )
```

## Volcano Plots {.tabset .tabset-fade}

### Input total proteome
```{r, fig.width=ifelse(length(params$results[["Visualization"]]$plots[["InputVolcanoPlots"]]) > 2, 8, 8), fig.height=ifelse(length(params$results[["Visualization"]]$plots[["InputVolcanoPlots"]]) > 2, 8, 4)}
print(params$results[["Visualization"]]$plots[["InputVolcanoPlots"]])
```

```{r}
DT::datatable(params$results[["Visualization"]]$tables[["InputSig"]],
    extensions = 'Buttons',
    caption = "Input Sig Proteins",
    options = list(
      dom = 'Bfrtip',
      buttons = c('csv', 'excel')
    )
  )
```

### diGly
```{r, fig.width=ifelse(length(params$results[["Visualization"]]$plots[["diGlyVolcanoPlots"]]) > 2, 8, 8), fig.height=ifelse(length(params$results[["Visualization"]]$plots[["diGlyVolcanoPlots"]]) > 2, 8, 4)}
print(params$results[["Visualization"]]$plots[["diGlyVolcanoPlots"]])
```

```{r}
DT::datatable(params$results[["Visualization"]]$tables[["diGlySig"]],
    extensions = 'Buttons',
    caption = "diGly Sig Proteins",
    options = list(
      dom = 'Bfrtip',
      buttons = c('csv', 'excel')
    )
  )
```

## Scatter Plots

One important aspect of diGly experiments is to compare fold changes of modified sites with total proteome fold changes. In cases where a protein is increasing or decreasing in expression, its modified sites might also increase/decrease just because they are following the protein trend, and not because our perturbation affected the modified site.

Therefore, these scatter plots provide a more tailored list of candidates taking into account changes at the total proteome level.

```{r, fig.width=ifelse(length(params$results[["Visualization"]]$plots[["ScatterPlots"]]) > 2, 8, 8), fig.height=ifelse(length(params$results[["Visualization"]]$plots[["ScatterPlots"]]) > 2, 8, 4)}
print(params$results[["Visualization"]]$plots[["ScatterPlots"]])
```

```{r}
DT::datatable(params$results[["Visualization"]]$tables[["ScatterSig"]],
    extensions = 'Buttons',
    caption = "Scatter Sig Proteins",
    options = list(
      dom = 'Bfrtip',
      buttons = c('csv', 'excel')
    )
  )
```

## E3 Ubiquitin Ligase Analysis

This analysis assumes that if one E3 Ligase is active, all of its substrates should be affected in the diGly experiment. Therefore, we would expect increases in modified site of all known E3 substrates. The main caveat of this analysis is that it's biased for the known substrates of the E3 ligases, therefore it does not necessarily exclude E3 ligases that are not found as enriched in our datasets.

In summary, we calculate the ratios between one condition and the control (e.g., mut-wt), normalize these ratios based on the total proteome ratios (when total proteome data is matched) and perform statistics comparing the E3 ligase substrate ratios to a randomly selected group of proteins of similar size. More information on how the analysis is done can be found in [the paper](https://doi.org/10.1093/bioinformatics/btac069).

As with all other comparative plots, these use the contrasts defined in the contrast table in the Data Visualization section.

```{r, fig.width=ifelse(length(params$results[["E3 Ligase Analysis"]]$plots[["VolcanoPlots"]]) > 2, 8, 8), fig.height=ifelse(length(params$results[["E3 Ligase Analysis"]]$plots[["VolcanoPlots"]]) > 2, 8, 4)}
print(params$results[["E3 Ligase Analysis"]]$plots[["VolcanoPlots"]])
```

```{r}
DT::datatable(params$results[["E3 Ligase Analysis"]]$tables[["E3Sig"]],
    extensions = 'Buttons',
    caption = "E3 Ligase Enrichment",
    options = list(
      dom = 'Bfrtip',
      buttons = c('csv', 'excel')
    )
  )
```

# System Info
```{r}
sessionInfo()
```
